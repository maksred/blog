---
authors:
- cunnie
categories:
- BOSH
- Concourse
date: 2017-10-24T17:16:22Z
draft: true
short: |
  BOSH directors can be deployed (and redeployed) with a properly built
  Concourse pipeline and manifests generated by the curated
  `bosh-deployment` manifest generation tool. This dramatically lightens
  the burden of keeping one's BOSH directors patched & up-to-date.
title: Maintaining BOSH Directors with Concourse CI and bosh-deployment
---

*"BOSH deploys Concourse, and Concourse deploys BOSH" —Cloud Foundry koan*

A BOSH Director is a VM (virtual machine) orchestrator which is, in turn, a VM.
BOSH solves the problem of keeping its VMs' applications (operating systems
(stemcells) and releases) up-to-date with the command, `bosh deploy`; however,
this begs the question, "what keeps my BOSH Director up-to-date?". <sup><a
href="#bosh_up_to_date" class="alert-link">[Updating BOSH]</a></sup>

We explore using [Concourse](https://concourse.ci/), a Continuous Integration
(CI) server, and
[bosh-deployment](https://github.com/cloudfoundry/bosh-deployment/), in order to
create a [Concourse pipeline](https://github.com/cloudfoundry/bosh-deployment/)
which updates, in turn, a BOSH director on AWS (Amazon Web Services), on
Microsoft Azure, and GCP (Google Cloud Platform). Updating all three BOSH
directors can be accomplished with a single click. <sup><a href="#one_click"
class="alert-link">[One click]</a></sup> Best of all, our directors are re-deployed
with a recent stemcell, BOSH release, and CPI release.  <sup><a
href="#how_recent" class="alert-link">[How recent?]</a></sup>

## 0. Introduction

{{< responsive-figure src="https://docs.google.com/drawings/d/e/2PACX-1vTXkKXrmPKiLkU2AwIiDWtA5FDun6u8TvGN49SbZ1jlsRScOyQT_B4sInIryzCveyK3-ia1DjSyvFLT/pub?w=1224&h=1584" >}}

We use a two-part

| IaaS  | Script | Manifest | Notes |
|-------|--------|----------|-------|
| AWS   | [aws.sh](https://github.com/cunnie/deployments/blob/d47af699bf11c4b168abfb9d5119ecc6dfddc06f/bin/aws.sh) | [bosh-aws.yml](https://github.com/cunnie/deployments/blob/d47af699bf11c4b168abfb9d5119ecc6dfddc06f/bosh-aws.yml) |
| Azure | [azure.sh](https://github.com/cunnie/deployments/blob/d47af699bf11c4b168abfb9d5119ecc6dfddc06f/bin/azure.sh) | [bosh-azure.yml](https://github.com/cunnie/deployments/blob/d47af699bf11c4b168abfb9d5119ecc6dfddc06f/bosh-azure.yml) |
| GCP   | [gce.sh](https://github.com/cunnie/deployments/blob/d47af699bf11c4b168abfb9d5119ecc6dfddc06f/bin/gce.sh) | [bosh-gce.yml](https://github.com/cunnie/deployments/blob/d47af699bf11c4b168abfb9d5119ecc6dfddc06f/bosh-gce.yml) |

## 1. Concourse Tasks



{{< responsive-figure src="https://user-images.githubusercontent.com/1020675/31297994-0405c082-aa9d-11e7-9669-b8f08852d286.png" >}}

## 2. Concourse Jobs & Tasks



## 3. Security

Our entire credential set is stored in our Concourse pipelines and the following command would expose them:

```bash
fly -t ci.nono.io get-pipeline -p BOSH
```

## References



## Footnotes

<a name="how_recent"><sup>[How recent?]</sup></a> How fresh is
`bosh-deployment`? Fairly fresh. For example, although as of the time of this
writing, `bosh-deployment` doesn't have the most recent stemcell (**3468**,
published on <https://bosh.io/>), it has a reasonably-recent stemcell
(**3445.7**). In fact, `bosh-deployment` is a quite active git repo, typically
updated [several times or more each
week](https://github.com/cloudfoundry/bosh-deployment/graphs/commit-activity).
It's the tool that the BOSH team, and many Cloud Foundry teams, use to keep
their BOSH directors current.

<a name="bosh_up_to_date"><sup>[Updating BOSH]</sup></a> In the early days, the
BOSH micro plugin was the mechanism to update the BOSH director. There were
several drawbacks to the micro plugin, one of which is that it forced the BOSH
CLI to have an understanding of the API for various IaaSes, breaking the Cloud
Layer abstraction model.

Another drawback of the BOSH micro plugin was that it was brittle, so much so
that it was a common pattern to deploy a BOSH director whose sole purpose was to
deploy the "real" BOSH director. "Ha!" one might ask, "But how did you keep that
first BOSH director up-to-date?" The answer is simple: you didn't. You left that
first BOSH director running and never touched it except to redeploy the "real"
BOSH director. You might spin it down if you weren't using it, but you never
deleted it or updated it.

These were serious problems, and to address them the BOSH Core team wrote
[`bosh-init`](https://github.com/cloudfoundry/docs-bosh/commit/a159cc4f6633ca26d7c9ce1d4ace961b0d1bad20),
a Golang-based executable whose purpose was to deploy BOSH directors. It adhered
to the Cloud Layer abstraction models (it used the existing CPIs (Cloud Provider
Interfaces) for the existing IaaSes ([VMware
vSphere](https://github.com/cloudfoundry-incubator/bosh-vsphere-cpi-release),
[Google Cloud
Platform](https://github.com/cloudfoundry-incubator/bosh-google-cpi-release)
(GCP),
[OpenStack]() [Microsoft
Azure](https://github.com/cloudfoundry-incubator/bosh-azure-cpi-release), among others)

By April 30, 2015, `bosh-init` was production-ready, and the BOSH documentation
was [updated](https://github.com/cloudfoundry/docs-bosh/commit/a159cc4f6633ca26d7c9ce1d4ace961b0d1bad20)
to reflect the new world order.

But all was not perfect in the Garden of Eden, for the introduction of
`bosh-init` split the CLIs: whereas before there was one BOSH CLI, now there
were two: `bosh`, the original Ruby-based CLI for managing a BOSH director's
deployment, and `bosh-init` for deploying a BOSH director itself. In many ways
this resembled the [Western
Schism](https://en.wikipedia.org/wiki/Western_Schism), a dark chapter in the
Roman Catholic church when there were two popes (who had the terrible habit of
excommunicating each other). The BOSH development team remedied this situation
by creating a _third_ CLI, the [Golang-based
CLI](https://bosh.io/docs/cli-v2.html). In this regard, the BOSH development
team's approach mirrored the approach attempted by the Catholic cardinals,
who elected a _third_ pope. The BOSH team's approach succeeded, but the
cardinals' didn't (they were left with three popes running around
excommunicating each other).

<a name="one_click"><sup>[One click]</sup></a> It's technically possible
to kick off the builds with _zero_ clicks — to kick off the build automatically
if, say, a commit is pushed to the _bosh-deployment_ repository. The modification
to the pipeline is trivial:

```diff
 - name: bosh-aws.nono.io
   plan:
   - get: cunnie-deployments
   - get: bosh-deployment
+    trigger: true
 - task: deploy
```

However, the decision to trigger automatically is not without risks: the BOSH
director may be in the middle of a delicate task, such as updating a deployment,
and won't have the opportunity to gracefully bring itself down, for`bosh
create-env` is relentless, brooks no delays, and gives no quarter.

On a more technical note, `bosh create-env`, although it will attempt to contact
the [BOSH agent](https://github.com/cloudfoundry/bosh-agent) on the original
BOSH director in order to terminate the jobs and shut down the VM, it does not
run the [drain scripts](https://bosh.io/docs/drain.html) (scripts which allow
the BOSH jobs to clean up and get into a state where they can be safely
stopped).

There is discussion within the BOSH development team whether to modify the
behavior of `bosh create-env` to make it run the drain scripts. On the positive
side, it will allow a more cavalier approach to re-deploying the director, and
make the behavior of `bosh create-env` more closely approximate the behavior of
a BOSH director. On the downside, the time to deploy a BOSH director may vary
widely, dependent on the time it takes for the drain scripts to complete.
